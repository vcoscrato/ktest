#' kTest
#'
#' Performs a hypothesis test for equality of distributions based on the estimated kernel densities and the permutation test.
#'
#' @param data Either a list of numeric vectors, a numeric vector (with classes parameter defined), or a stacked data frame (first column with numeric values and second column with classes).
#' @param classes Classes relative to data parameter, should be used only when data is a numeric vector.
#' @param perm Boolean indicating weather to obtain the p-value trough the permutation test or just return return the common area between densities.
#' @param B Number of permutations.
#' @param pairwise Boolean indicating weather to obtain pairwise p-values (valid only if > 2 groups). If the number of groups is big, this will make the execution much slower.
#' @param bw The bandwidth used to estimate the kernel densities.
#' @param npoints The number of points used to estimate the kernel densities.
#' @param pairsPlot Boolean indicating weather to plot density pairs or not (usefull to detect witch densities differ).
#' @param threads Number of cores to be used for parallel computing.
#'
#' @return A list containing:
#'
#' - commonArea: Common area between the kernel densities.
#'
#' - p.value: The p-value generated by the permutation test (if perm = TRUE).
#'
#' - pairwiseCommonArea: Groups pairwise common area triangular matrix.
#'
#' - pairwisep.value: Groups pairwise p-value triangular matrix generated by the permutation test (if perm = TRUE, pairwise = TRUE and > 3 groups).
#'
#' @export
#'
#' @examples data = list(x = rnorm(30), y = rexp(50), z = rpois(70, 1))
#' kTest(data)

kTest = function(data, classes = NULL, perm = TRUE, B = 5000, pairwise = FALSE, bw = bw.nrd0, npoints = 512, pairsPlot = TRUE, threads = detectCores() - 1) {

  data = convertDataStacked(data, classes)

  densities = densitiesEval(data, bw = bw(data[,1]), npoints)

  if(length(densities$labels) < 3 & pairwise == TRUE) {

    warning('pairwise not relevant when number of groups is less then 3.')

    pairwise = FALSE

  }

  k = commonArea(densities$densities)

  pairwiseca = pairwiseCommonArea(densities$densities, densities$labels)

  if(perm) {

    p = permTest(data, B, threads, bw = bw(data[,1]), npoints, k)

    if(pairwise) {

      pairwisep = pairwisePermTest(data, densities$labels, B, threads, bw, npoints, pairwiseca)

    } else {

      pairwisep = NULL

    }

  } else {

    pairwisep = NULL

    p = NULL

  }

  if(pairsPlot) {

    densityPairs(densities$densities, densities$labels, pairwiseca, pairwisep)

  }

  output = list(commonArea = k, pairwiseCommonArea = pairwiseca)

  if(!is.null(p)) {

    output$p.value = p

  }

  if(!is.null(pairwisep)) {

    output$pairwisep.value = pairwisep

  }

  class(output) = 'kTest'

  return(output)
}


#' @export

print.kTest = function(output) {

  cat(paste('\n', nrow(output$pairwiseCommonArea), 'densities kTest results:\n\n'))

  cat(paste('- Common area between all densities:', round(output$commonArea, 4)))

  cat(paste('\n\n- p-value of the test:', round(output$p.value, 4),'\n\n'))

  pander(output$pairwiseCommonArea, plain.ascii = TRUE, caption = 'Pairwise Common Area')

  pander(output$pairwisep.value, plain.ascii = TRUE, caption = 'Pairwise p-value')
}
